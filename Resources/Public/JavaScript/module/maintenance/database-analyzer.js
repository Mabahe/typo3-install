/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{AbstractInteractableModule}from"@typo3/install/module/abstract-interactable-module.js";import Modal from"@typo3/backend/modal.js";import Notification from"@typo3/backend/notification.js";import AjaxRequest from"@typo3/core/ajax/ajax-request.js";import{InfoBox}from"@typo3/install/renderable/info-box.js";import Severity from"@typo3/install/renderable/severity.js";import Router from"@typo3/install/router.js";import RegularEvent from"@typo3/core/event/regular-event.js";class DatabaseAnalyzer extends AbstractInteractableModule{constructor(){super(...arguments),this.selectorAnalyzeTrigger=".t3js-databaseAnalyzer-analyze",this.selectorExecuteTrigger=".t3js-databaseAnalyzer-execute",this.selectorOutputContainer=".t3js-databaseAnalyzer-output",this.selectorSuggestionBlock=".t3js-databaseAnalyzer-suggestion-block",this.selectorSuggestionList=".t3js-databaseAnalyzer-suggestion-list",this.selectorSuggestionLineTemplate=".t3js-databaseAnalyzer-suggestion-line-template"}initialize(e){super.initialize(e),this.getData(),new RegularEvent("click",((e,t)=>{t.closest("fieldset").querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=t.checked}))})).delegateTo(e,".t3js-databaseAnalyzer-suggestion-block-checkbox"),new RegularEvent("click",(e=>{e.preventDefault(),this.analyze()})).delegateTo(e,this.selectorAnalyzeTrigger),new RegularEvent("click",(e=>{e.preventDefault(),this.execute()})).delegateTo(e,this.selectorExecuteTrigger)}getData(){const e=this.getModalBody();new AjaxRequest(Router.getUrl("databaseAnalyzer")).get({cache:"no-cache"}).then((async t=>{const s=await t.resolve();!0===s.success?(e.innerHTML=s.html,Modal.setButtons(s.buttons),this.analyze()):Notification.error("Something went wrong","The request was not processed successfully. Please check the browser's console and TYPO3's log.")}),(t=>{Router.handleAjaxError(t,e)}))}analyze(){this.setModalButtonsState(!1);const e=this.getModalBody(),t=e.querySelector(this.selectorOutputContainer),s=this.renderProgressBar(t,{label:"Analyzing current database schema..."});new RegularEvent("change",(()=>{const e=t.querySelectorAll(":checked").length>0;this.setModalButtonState(this.getModalFooter().querySelector(this.selectorExecuteTrigger),e)})).delegateTo(t,'input[type="checkbox"]'),new AjaxRequest(Router.getUrl("databaseAnalyzerAnalyze")).get({cache:"no-cache"}).then((async a=>{const r=await a.resolve();!0===r.success?(Array.isArray(r.status)&&(s.remove(),r.status.forEach((e=>{t.append(InfoBox.create(e.severity,e.title,e.message))}))),Array.isArray(r.suggestions)&&(r.suggestions.forEach((s=>{const a=e.querySelector(this.selectorSuggestionBlock).cloneNode(!0);a.classList.remove(this.selectorSuggestionBlock.substring(1));const r=s.key;a.querySelector(".t3js-databaseAnalyzer-suggestion-block-legend").innerText=s.label,a.querySelector(".t3js-databaseAnalyzer-suggestion-block-checkbox").setAttribute("id","t3-install-"+r+"-checkbox"),s.enabled&&a.querySelector(".t3js-databaseAnalyzer-suggestion-block-checkbox").setAttribute("checked","checked"),a.querySelector(".t3js-databaseAnalyzer-suggestion-block-label").setAttribute("for","t3-install-"+r+"-checkbox"),s.children.forEach((t=>{const r=e.querySelector(this.selectorSuggestionLineTemplate).children[0].cloneNode(!0),o=t.hash,n=r.querySelector(".t3js-databaseAnalyzer-suggestion-line-checkbox");n.setAttribute("id","t3-install-db-"+o),n.setAttribute("data-hash",o),s.enabled&&n.setAttribute("checked","checked"),r.querySelector(".t3js-databaseAnalyzer-suggestion-line-label").setAttribute("for","t3-install-db-"+o),r.querySelector(".t3js-databaseAnalyzer-suggestion-line-statement").innerText=t.statement,void 0!==t.current&&(r.querySelector(".t3js-databaseAnalyzer-suggestion-line-current-value").innerText=t.current,r.querySelector(".t3js-databaseAnalyzer-suggestion-line-current").style.display="inline"),void 0!==t.rowCount&&(r.querySelector(".t3js-databaseAnalyzer-suggestion-line-count-value").innerText=t.rowCount,r.querySelector(".t3js-databaseAnalyzer-suggestion-line-count").style.display="inline"),a.querySelector(this.selectorSuggestionList).append(r)})),t.append(a)})),this.setModalButtonState(this.getModalFooter().querySelector(this.selectorAnalyzeTrigger),!0),this.setModalButtonState(this.getModalFooter().querySelector(this.selectorExecuteTrigger),t.querySelectorAll(":checked").length>0)),0===r.suggestions.length&&0===r.status.length&&t.append(InfoBox.create(Severity.ok,"Database schema is up to date. Good job!"))):Notification.error("Something went wrong","The request was not processed successfully. Please check the browser's console and TYPO3's log.")}),(t=>{Router.handleAjaxError(t,e)}))}execute(){this.setModalButtonsState(!1);const e=this.getModalBody(),t=this.getModuleContent().dataset.databaseAnalyzerExecuteToken,s=e.querySelector(this.selectorOutputContainer),a=[];s.querySelectorAll(".t3js-databaseAnalyzer-suggestion-line input:checked").forEach((e=>{a.push(e.dataset.hash)})),this.renderProgressBar(s,{label:"Executing database updates..."}),new AjaxRequest(Router.getUrl()).post({install:{action:"databaseAnalyzerExecute",token:t,hashes:a}}).then((async e=>{const t=await e.resolve();Array.isArray(t.status)&&t.status.forEach((e=>{Notification.showMessage(e.title,e.message,e.severity)})),this.analyze()}),(t=>{Router.handleAjaxError(t,e)}))}}export default new DatabaseAnalyzer;