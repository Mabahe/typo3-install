/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();define(["require","exports","./AbstractInteractableModule","jquery","../Router","../Renderable/Severity","../Renderable/ProgressBar","../Renderable/InfoBox","../Renderable/FlashMessage","TYPO3/CMS/Backend/Notification","TYPO3/CMS/Core/SecurityUtility","bootstrap"],function(e,t,r,a,s,i,n,o,d,l,c){"use strict";return new(function(e){function t(){var t=e.call(this)||this;return t.selectorOutputWizardsContainer=".t3js-upgradeWizards-wizards-output",t.selectorOutputDoneContainer=".t3js-upgradeWizards-done-output",t.selectorWizardsBlockingAddsTemplate=".t3js-upgradeWizards-blocking-adds-template",t.selectorWizardsBlockingAddsRows=".t3js-upgradeWizards-blocking-adds-rows",t.selectorWizardsBlockingAddsExecute=".t3js-upgradeWizards-blocking-adds-execute",t.selectorWizardsBlockingCharsetTemplate=".t3js-upgradeWizards-blocking-charset-template",t.selectorWizardsBlockingCharsetFix=".t3js-upgradeWizards-blocking-charset-fix",t.selectorWizardsDoneBodyTemplate=".t3js-upgradeWizards-done-body-template",t.selectorWizardsDoneRows=".t3js-upgradeWizards-done-rows",t.selectorWizardsDoneRowTemplate=".t3js-upgradeWizards-done-row-template table tr",t.selectorWizardsDoneRowMarkUndone=".t3js-upgradeWizards-done-markUndone",t.selectorWizardsDoneRowTitle=".t3js-upgradeWizards-done-title",t.selectorWizardsListTemplate=".t3js-upgradeWizards-list-template",t.selectorWizardsListRows=".t3js-upgradeWizards-list-rows",t.selectorWizardsListRowTemplate=".t3js-upgradeWizards-list-row-template",t.selectorWizardsListRowTitle=".t3js-upgradeWizards-list-row-title",t.selectorWizardsListRowExplanation=".t3js-upgradeWizards-list-row-explanation",t.selectorWizardsListRowExecute=".t3js-upgradeWizards-list-row-execute",t.selectorWizardsInputTemplate=".t3js-upgradeWizards-input",t.selectorWizardsInputTitle=".t3js-upgradeWizards-input-title",t.selectorWizardsInputHtml=".t3js-upgradeWizards-input-html",t.selectorWizardsInputPerform=".t3js-upgradeWizards-input-perform",t.securityUtility=new c,t}return __extends(t,e),t.removeLoadingMessage=function(e){e.find(".alert-loading").remove()},t.renderProgressBar=function(e){return n.render(i.loading,e,"")},t.prototype.initialize=function(e){var t=this;this.currentModal=e,this.getData().done(function(){t.doneUpgrades()}),e.on("click",this.selectorWizardsDoneRowMarkUndone,function(e){t.markUndone(e.target.dataset.identifier)}),e.on("click",this.selectorWizardsBlockingCharsetFix,function(e){t.blockingUpgradesDatabaseCharsetFix()}),e.on("click",this.selectorWizardsBlockingAddsExecute,function(e){t.blockingUpgradesDatabaseAddsExecute()}),e.on("click",this.selectorWizardsListRowExecute,function(e){t.wizardInput(e.target.dataset.identifier,e.target.dataset.title)}),e.on("click",this.selectorWizardsInputPerform,function(e){t.wizardExecute(e.target.dataset.identifier,e.target.dataset.title)})},t.prototype.getData=function(){var e=this,t=this.getModalBody();return a.ajax({url:s.getUrl("upgradeWizardsGetData"),cache:!1,success:function(r){!0===r.success?(t.empty().append(r.html),e.blockingUpgradesDatabaseCharsetTest()):l.error("Something went wrong")},error:function(e){s.handleAjaxError(e)}})},t.prototype.blockingUpgradesDatabaseCharsetTest=function(){var e=this,r=this.getModalBody(),i=this.findInModal(this.selectorOutputWizardsContainer);i.empty().html(t.renderProgressBar("Checking database charset...")),a.ajax({url:s.getUrl("upgradeWizardsBlockingDatabaseCharsetTest"),cache:!1,success:function(a){t.removeLoadingMessage(i),!0===a.success&&(!0===a.needsUpdate?r.find(e.selectorOutputWizardsContainer).append(r.find(e.selectorWizardsBlockingCharsetTemplate)).clone():e.blockingUpgradesDatabaseAdds())},error:function(e){s.handleAjaxError(e,i)}})},t.prototype.blockingUpgradesDatabaseCharsetFix=function(){var e=a(this.selectorOutputWizardsContainer);e.empty().html(t.renderProgressBar("Setting database charset to UTF-8...")),a.ajax({url:s.getUrl("upgradeWizardsBlockingDatabaseCharsetFix"),cache:!1,success:function(r){if(t.removeLoadingMessage(e),!0===r.success)Array.isArray(r.status)&&r.status.length>0&&r.status.forEach(function(t){var r=o.render(t.severity,t.title,t.message);e.append(r)});else{var a=d.render(i.error,"Something went wrong","");t.removeLoadingMessage(e),e.append(a)}},error:function(t){s.handleAjaxError(t,e)}})},t.prototype.blockingUpgradesDatabaseAdds=function(){var e=this,r=this.getModalBody(),i=this.findInModal(this.selectorOutputWizardsContainer);i.empty().html(t.renderProgressBar("Check for missing mandatory database tables and fields...")),a.ajax({url:s.getUrl("upgradeWizardsBlockingDatabaseAdds"),cache:!1,success:function(a){if(t.removeLoadingMessage(i),!0===a.success)if(!0===a.needsUpdate){var s=r.find(e.selectorWizardsBlockingAddsTemplate).clone();"object"==typeof a.adds.tables&&a.adds.tables.forEach(function(t){var r="Table: "+e.securityUtility.encodeHtml(t.table);s.find(e.selectorWizardsBlockingAddsRows).append(r,"<br>")}),"object"==typeof a.adds.columns&&a.adds.columns.forEach(function(t){var r="Table: "+e.securityUtility.encodeHtml(t.table)+", Field: "+e.securityUtility.encodeHtml(t.field);s.find(e.selectorWizardsBlockingAddsRows).append(r,"<br>")}),"object"==typeof a.adds.indexes&&a.adds.indexes.forEach(function(t){var r="Table: "+e.securityUtility.encodeHtml(t.table)+", Index: "+e.securityUtility.encodeHtml(t.index);s.find(e.selectorWizardsBlockingAddsRows).append(r,"<br>")}),r.find(e.selectorOutputWizardsContainer).append(s)}else e.wizardsList();else l.error("Something went wrong")},error:function(e){s.handleAjaxError(e,i)}})},t.prototype.blockingUpgradesDatabaseAddsExecute=function(){var e=this,r=this.findInModal(this.selectorOutputWizardsContainer);r.empty().html(t.renderProgressBar("Adding database tables and fields...")),a.ajax({url:s.getUrl("upgradeWizardsBlockingDatabaseExecute"),cache:!1,success:function(a){if(t.removeLoadingMessage(r),!0===a.success)Array.isArray(a.status)&&a.status.length>0&&(a.status.forEach(function(e){var t=o.render(e.severity,e.title,e.message);r.append(t)}),e.wizardsList());else{var s=d.render(i.error,"Something went wrong","");t.removeLoadingMessage(r),r.append(s)}},error:function(e){s.handleAjaxError(e,r)}})},t.prototype.wizardsList=function(){var e=this,r=this.getModalBody(),i=this.findInModal(this.selectorOutputWizardsContainer);i.append(t.renderProgressBar("Loading upgrade wizards...")),a.ajax({url:s.getUrl("upgradeWizardsList"),cache:!1,success:function(a){t.removeLoadingMessage(i);var s=r.find(e.selectorWizardsListTemplate).clone();if(s.removeClass("t3js-upgradeWizards-list-template"),!0===a.success){var n=0,o=0;Array.isArray(a.wizards)&&a.wizards.length>0&&(o=a.wizards.length,a.wizards.forEach(function(t){if(!0===t.shouldRenderWizard){var a=r.find(e.selectorWizardsListRowTemplate).clone();n+=1,a.removeClass("t3js-upgradeWizards-list-row-template"),a.find(e.selectorWizardsListRowTitle).empty().text(t.title),a.find(e.selectorWizardsListRowExplanation).empty().text(t.explanation),a.find(e.selectorWizardsListRowExecute).attr("data-identifier",t.identifier).attr("data-title",t.title),s.find(e.selectorWizardsListRows).append(a)}}),s.find(e.selectorWizardsListRows+" hr:last").remove());var d=100,c=s.find(".progress-bar");n>0?d=Math.round((o-n)/a.wizards.length*100):c.removeClass("progress-bar-info").addClass("progress-bar-success"),c.removeClass("progress-bar-striped").css("width",d+"%").attr("aria-valuenow",d).find("span").text(d+"%"),r.find(e.selectorOutputWizardsContainer).append(s),e.findInModal(e.selectorWizardsDoneRowMarkUndone).prop("disabled",!1)}else l.error("Something went wrong")},error:function(e){s.handleAjaxError(e,i)}})},t.prototype.wizardInput=function(e,r){var i=this,n=this.getModuleContent().data("upgrade-wizards-input-token"),o=this.getModalBody(),l=this.findInModal(this.selectorOutputWizardsContainer);l.empty().html(t.renderProgressBar('Loading "'+r+'"...')),o.animate({scrollTop:o.scrollTop()-Math.abs(o.find(".t3js-upgrade-status-section").position().top)},250),a.ajax({url:s.getUrl(),method:"POST",data:{install:{action:"upgradeWizardsInput",token:n,identifier:e}},cache:!1,success:function(e){l.empty();var t=o.find(i.selectorWizardsInputTemplate).clone();t.removeClass("t3js-upgradeWizards-input"),!0===e.success&&(Array.isArray(e.status)&&e.status.forEach(function(e){var t=d.render(e.severity,e.title,e.message);l.append(t)}),e.userInput.wizardHtml.length>0&&t.find(i.selectorWizardsInputHtml).html(e.userInput.wizardHtml),t.find(i.selectorWizardsInputTitle).text(e.userInput.title),t.find(i.selectorWizardsInputPerform).attr("data-identifier",e.userInput.identifier).attr("data-title",e.userInput.title)),o.find(i.selectorOutputWizardsContainer).append(t)},error:function(e){s.handleAjaxError(e,l)}})},t.prototype.wizardExecute=function(e,r){var i=this,n=this.getModuleContent().data("upgrade-wizards-execute-token"),d=this.getModalBody(),c={"install[action]":"upgradeWizardsExecute","install[token]":n,"install[identifier]":e};a(this.findInModal(this.selectorOutputWizardsContainer+" form").serializeArray()).each(function(e,t){c[t.name]=t.value});var u=this.findInModal(this.selectorOutputWizardsContainer);u.empty().html(t.renderProgressBar('Executing "'+r+'"...')),this.findInModal(this.selectorWizardsDoneRowMarkUndone).prop("disabled",!0),a.ajax({method:"POST",data:c,url:s.getUrl(),cache:!1,success:function(e){u.empty(),!0===e.success?(Array.isArray(e.status)&&e.status.forEach(function(e){var t=o.render(e.severity,e.title,e.message);u.append(t)}),i.wizardsList(),d.find(i.selectorOutputDoneContainer).empty(),i.doneUpgrades()):l.error("Something went wrong")},error:function(e){s.handleAjaxError(e,u)}})},t.prototype.doneUpgrades=function(){var e=this,r=this.getModalBody(),i=r.find(this.selectorOutputDoneContainer);i.empty().html(t.renderProgressBar("Loading executed upgrade wizards...")),a.ajax({url:s.getUrl("upgradeWizardsDoneUpgrades"),cache:!1,success:function(a){if(t.removeLoadingMessage(i),!0===a.success){Array.isArray(a.status)&&a.status.length>0&&a.status.forEach(function(e){var t=o.render(e.severity,e.title,e.message);i.append(t)});var s=r.find(e.selectorWizardsDoneBodyTemplate).clone(),n=s.find(e.selectorWizardsDoneRows),d=!1;Array.isArray(a.wizardsDone)&&a.wizardsDone.length>0&&a.wizardsDone.forEach(function(t){d=!0;var a=r.find(e.selectorWizardsDoneRowTemplate).clone();a.find(e.selectorWizardsDoneRowMarkUndone).attr("data-identifier",t.identifier),a.find(e.selectorWizardsDoneRowTitle).text(t.title),n.append(a)}),Array.isArray(a.rowUpdatersDone)&&a.rowUpdatersDone.length>0&&a.rowUpdatersDone.forEach(function(t){d=!0;var a=r.find(e.selectorWizardsDoneRowTemplate).clone();a.find(e.selectorWizardsDoneRowMarkUndone).attr("data-identifier",t.identifier),a.find(e.selectorWizardsDoneRowTitle).text(t.title),n.append(a)}),d&&(r.find(e.selectorOutputDoneContainer).append(s),e.findInModal(e.selectorWizardsDoneRowMarkUndone).prop("disabled",!0))}else l.error("Something went wrong")},error:function(e){s.handleAjaxError(e,i)}})},t.prototype.markUndone=function(e){var r=this,i=this.getModuleContent().data("upgrade-wizards-mark-undone-token"),n=this.getModalBody(),o=this.findInModal(this.selectorOutputDoneContainer);o.empty().html(t.renderProgressBar("Marking upgrade wizard as undone...")),a.ajax({url:s.getUrl(),method:"POST",data:{install:{action:"upgradeWizardsMarkUndone",token:i,identifier:e}},cache:!1,success:function(e){o.empty(),n.find(r.selectorOutputDoneContainer).empty(),!0===e.success&&Array.isArray(e.status)?e.status.forEach(function(e){l.success(e.message),r.doneUpgrades(),r.blockingUpgradesDatabaseCharsetTest()}):l.error("Something went wrong")},error:function(e){s.handleAjaxError(e,o)}})},t}(r.AbstractInteractableModule))});