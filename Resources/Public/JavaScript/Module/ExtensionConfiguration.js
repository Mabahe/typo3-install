/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","../Router","TYPO3/CMS/Backend/Notification","bootstrap"],function(t,e,a,r,n){"use strict";return new(function(){function e(){this.selectorModalBody=".t3js-modal-body",this.selectorModuleContent=".t3js-module-content",this.selectorFormListener=".t3js-extensionConfiguration-form",this.selectorSearchInput=".t3js-extensionConfiguration-search"}return e.prototype.initialize=function(e){var r=this;this.currentModal=e,this.getContent(),e.on("keydown",function(t){var a=e.find(r.selectorSearchInput);t.ctrlKey||t.metaKey?"f"===String.fromCharCode(t.which).toLowerCase()&&(t.preventDefault(),a.focus()):27===t.keyCode&&(t.preventDefault(),a.val("").focus())}),e.on("keyup",this.selectorSearchInput,function(n){var i=a(n.target).val(),o=e.find(r.selectorSearchInput);e.find(".search-item").each(function(t,e){var r=a(e);a(":contains("+i+")",r).length>0||a('input[value*="'+i+'"]',r).length>0?r.removeClass("hidden").addClass("searchhit"):r.removeClass("searchhit").addClass("hidden")}),e.find(".searchhit").collapse("show"),t(["jquery.clearable"],function(){o.clearable().focus()})}),e.on("submit",this.selectorFormListener,function(t){t.preventDefault(),r.write(a(t.currentTarget))})},e.prototype.getContent=function(){var t=this,e=this.currentModal.find(this.selectorModalBody);a.ajax({url:r.getUrl("extensionConfigurationGetContent"),cache:!1,success:function(a){!0===a.success&&(Array.isArray(a.status)&&a.status.forEach(function(t){n.success(t.title,t.message)}),e.html(a.html),t.initializeWrap())},error:function(t){r.handleAjaxError(t,e)}})},e.prototype.write=function(t){var e=this.currentModal.find(this.selectorModalBody),i=this.currentModal.find(this.selectorModuleContent).data("extension-configuration-write-token"),o={};a.each(t.serializeArray(),function(t,e){o[e.name]=e.value}),a.ajax({url:r.getUrl(),method:"POST",data:{install:{token:i,action:"extensionConfigurationWrite",extensionKey:t.attr("data-extensionKey"),extensionConfiguration:o}},success:function(t){!0===t.success&&Array.isArray(t.status)?t.status.forEach(function(t){n.showMessage(t.title,t.message,t.severity)}):n.error("Something went wrong")},error:function(t){r.handleAjaxError(t,e)}}).always(function(){})},e.prototype.initializeWrap=function(){this.currentModal.find(".t3js-emconf-offset").each(function(t,e){var r=a(e),n=r.parent(),i=r.attr("id"),o=r.attr("value").split(",");r.attr("data-offsetfield-x","#"+i+"_offset_x").attr("data-offsetfield-y","#"+i+"_offset_y").wrap('<div class="hidden"></div>');var s=a("<div>",{class:"form-multigroup-item"}).append(a("<div>",{class:"input-group"}).append(a("<div>",{class:"input-group-addon"}).text("x"),a("<input>",{id:i+"_offset_x",class:"form-control t3js-emconf-offsetfield","data-target":"#"+i,value:a.trim(o[0])}))),d=a("<div>",{class:"form-multigroup-item"}).append(a("<div>",{class:"input-group"}).append(a("<div>",{class:"input-group-addon"}).text("y"),a("<input>",{id:i+"_offset_y",class:"form-control t3js-emconf-offsetfield","data-target":"#"+i,value:a.trim(o[1])}))),f=a("<div>",{class:"form-multigroup-wrap"}).append(s,d);n.append(f),n.find(".t3js-emconf-offsetfield").keyup(function(t){var e=n.find(a(t.currentTarget).data("target"));e.val(n.find(e.data("offsetfield-x")).val()+","+n.find(e.data("offsetfield-y")).val())})}),this.currentModal.find(".t3js-emconf-wrap").each(function(t,e){var r=a(e),n=r.parent(),i=r.attr("id"),o=r.attr("value").split("|");r.attr("data-wrapfield-start","#"+i+"_wrap_start").attr("data-wrapfield-end","#"+i+"_wrap_end").wrap('<div class="hidden"></div>');var s=a("<div>",{class:"form-multigroup-wrap"}).append(a("<div>",{class:"form-multigroup-item"}).append(a("<input>",{id:i+"_wrap_start",class:"form-control t3js-emconf-wrapfield","data-target":"#"+i,value:a.trim(o[0])})),a("<div>",{class:"form-multigroup-item"}).append(a("<input>",{id:i+"_wrap_end",class:"form-control t3js-emconf-wrapfield","data-target":"#"+i,value:a.trim(o[1])})));n.append(s),n.find(".t3js-emconf-wrapfield").keyup(function(t){var e=n.find(a(t.currentTarget).data("target"));e.val(n.find(e.data("wrapfield-start")).val()+"|"+n.find(e.data("wrapfield-end")).val())})})},e}())});