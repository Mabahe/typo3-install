/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","../Ajax/AjaxQueue","../Router","TYPO3/CMS/Backend/Notification","bootstrap"],function(e,n,t,s,i,a){"use strict";return new(function(){function e(){this.selectorModalBody=".t3js-modal-body",this.selectorModuleContent=".t3js-module-content",this.listOfAffectedRestFileHashes=[],this.selectorExtensionContainer=".t3js-extensionScanner-extension",this.selectorNumberOfFiles=".t3js-extensionScanner-number-of-files",this.selectorScanSingleTrigger=".t3js-extensionScanner-scan-single"}return e.prototype.initialize=function(e){var n=this;this.currentModal=e,this.getData(),e.on("show.bs.collapse",this.selectorExtensionContainer,function(e){var s=t(e.currentTarget);if(void 0===s.data("scanned")){var i=s.data("extension");n.scanSingleExtension(i),s.data("scanned",!0)}}).on("click",this.selectorScanSingleTrigger,function(e){e.preventDefault();var s=t(e.currentTarget).closest(n.selectorExtensionContainer).data("extension");n.scanSingleExtension(s)}).on("click",".t3js-extensionScanner-scan-all",function(t){t.preventDefault();var s=e.find(n.selectorExtensionContainer);n.scanAll(s)})},e.prototype.getData=function(){var e=this.currentModal.find(this.selectorModalBody);s.add({url:i.getUrl("extensionScannerGetData"),cache:!1,success:function(n){!0===n.success?e.empty().append(n.html):a.error("Something went wrong")},error:function(n){i.handleAjaxError(n,e)}})},e.prototype.getExtensionSelector=function(e){return this.selectorExtensionContainer+"-"+e},e.prototype.scanAll=function(e){var n=this;this.currentModal.find(this.selectorExtensionContainer).removeClass("panel-danger panel-warning panel-success").find(".panel-progress-bar").css("width",0).attr("aria-valuenow",0).find("span").text("0%"),this.setProgressForAll(),e.each(function(e,s){var i=t(s),a=i.data("extension");n.scanSingleExtension(a),i.data("scanned",!0)})},e.prototype.setStatusMessageForScan=function(e,n,t){this.currentModal.find(this.getExtensionSelector(e)).find(this.selectorNumberOfFiles).text("Checked "+n+" of "+t+" files")},e.prototype.setProgressForScan=function(e,n,t){var s=n/t*100;this.currentModal.find(this.getExtensionSelector(e)).find(".panel-progress-bar").css("width",s+"%").attr("aria-valuenow",s).find("span").text(s+"%")},e.prototype.setProgressForAll=function(){var e=this.currentModal.find(this.selectorExtensionContainer).length,n=this.currentModal.find(this.selectorExtensionContainer+".t3js-extensionscan-finished.panel-success").length+this.currentModal.find(this.selectorExtensionContainer+".t3js-extensionscan-finished.panel-warning").length+this.currentModal.find(this.selectorExtensionContainer+".t3js-extensionscan-finished.panel-danger").length,t=n/e*100,o=this.currentModal.find(this.selectorModalBody);this.currentModal.find(".t3js-extensionScanner-progress-all-extension .progress-bar").css("width",t+"%").attr("aria-valuenow",t).find("span").text(n+" of "+e+" scanned"),n===e&&(a.success("Scan finished","All extensions have been scanned"),s.add({url:i.getUrl(),method:"POST",data:{install:{action:"extensionScannerMarkFullyScannedRestFiles",token:this.currentModal.find(this.selectorModuleContent).data("extension-scanner-mark-fully-scanned-rest-files-token"),hashes:this.uniqueArray(this.listOfAffectedRestFileHashes)}},cache:!1,success:function(e){!0===e.success&&a.success("Marked not affected files","Marked "+e.markedAsNotAffected+" ReST files as not affected.")},error:function(e){i.handleAjaxError(e,o)}}))},e.prototype.uniqueArray=function(e){return e.filter(function(e,n,t){return t.indexOf(e)===n})},e.prototype.scanSingleExtension=function(e){var n=this,o=this.currentModal.find(this.selectorModuleContent).data("extension-scanner-files-token"),r=this.currentModal.find(this.selectorModalBody),l=this.currentModal.find(this.getExtensionSelector(e)),c=!1;l.removeClass("panel-danger panel-warning panel-success t3js-extensionscan-finished"),l.data("hasRun","true"),l.find(".t3js-extensionScanner-scan-single").text("Scanning...").attr("disabled","disabled"),l.find(".t3js-extensionScanner-extension-body-loc").empty().text("0"),l.find(".t3js-extensionScanner-extension-body-ignored-files").empty().text("0"),l.find(".t3js-extensionScanner-extension-body-ignored-lines").empty().text("0"),this.setProgressForAll(),s.add({url:i.getUrl(),method:"POST",data:{install:{action:"extensionScannerFiles",token:o,extension:e}},cache:!1,success:function(o){if(!0===o.success&&Array.isArray(o.files)){var d=o.files.length;if(d>0){n.setStatusMessageForScan(e,0,d),l.find(".t3js-extensionScanner-extension-body").text("");var f=0;o.files.forEach(function(o){s.add({method:"POST",data:{install:{action:"extensionScannerScanFile",token:n.currentModal.find(n.selectorModuleContent).data("extension-scanner-scan-file-token"),extension:e,file:o}},url:i.getUrl(),cache:!1,success:function(s){if(f++,n.setStatusMessageForScan(e,f,d),n.setProgressForScan(e,f,d),s.success&&t.isArray(s.matches)&&s.matches.forEach(function(e){c=!0;var s=r.find("#t3js-extensionScanner-file-hit-template").clone();s.find(".t3js-extensionScanner-hit-file-panel-head").attr("href","#collapse"+e.uniqueId),s.find(".t3js-extensionScanner-hit-file-panel-body").attr("id","collapse"+e.uniqueId),s.find(".t3js-extensionScanner-hit-filename").text(o),s.find(".t3js-extensionScanner-hit-message").text(e.message),"strong"===e.indicator?s.find(".t3js-extensionScanner-hit-file-panel-head .badges").append('<span class="badge" title="Reliable match, false positive unlikely">strong</span>'):s.find(".t3js-extensionScanner-hit-file-panel-head .badges").append('<span class="badge" title="Probable match, but can be a false positive">weak</span>'),!0===e.silenced&&s.find(".t3js-extensionScanner-hit-file-panel-head .badges").append('<span class="badge" title="Match has been annotated by extension author as false positive match">silenced</span>'),s.find(".t3js-extensionScanner-hit-file-lineContent").empty().text(e.lineContent),s.find(".t3js-extensionScanner-hit-file-line").empty().text(e.line+": "),t.isArray(e.restFiles)&&e.restFiles.forEach(function(e){var t=r.find("#t3js-extensionScanner-file-hit-rest-template").clone();t.find(".t3js-extensionScanner-hit-rest-panel-head").attr("href","#collapse"+e.uniqueId),t.find(".t3js-extensionScanner-hit-rest-panel-head .badge").empty().text(e.version),t.find(".t3js-extensionScanner-hit-rest-panel-body").attr("id","collapse"+e.uniqueId),t.find(".t3js-extensionScanner-hit-rest-headline").text(e.headline),t.find(".t3js-extensionScanner-hit-rest-body").text(e.content),t.addClass("panel-"+e.class),s.find(".t3js-extensionScanner-hit-file-rest-container").append(t),n.listOfAffectedRestFileHashes.push(e.file_hash)});var i=s.find(".panel-breaking",".t3js-extensionScanner-hit-file-rest-container").length>0?"panel-danger":"panel-warning";s.addClass(i),l.find(".t3js-extensionScanner-extension-body").removeClass("hide").append(s),"panel-danger"===i&&l.removeClass("panel-warning").addClass(i),"panel-warning"!==i||l.hasClass("panel-danger")||l.addClass(i)}),s.success){var i=parseInt(l.find(".t3js-extensionScanner-extension-body-loc").text(),10);if(l.find(".t3js-extensionScanner-extension-body-loc").empty().text(i+s.effectiveCodeLines),s.isFileIgnored){var a=parseInt(l.find(".t3js-extensionScanner-extension-body-ignored-files").text(),10);l.find(".t3js-extensionScanner-extension-body-ignored-files").empty().text(a+1)}var h=parseInt(l.find(".t3js-extensionScanner-extension-body-ignored-lines").text(),10);l.find(".t3js-extensionScanner-extension-body-ignored-lines").empty().text(h+s.ignoredLines)}f===d&&(c||l.addClass("panel-success"),l.addClass("t3js-extensionscan-finished"),n.setProgressForAll(),l.find(".t3js-extensionScanner-scan-single").text("Rescan").attr("disabled",null))},error:function(t){f+=1,n.setStatusMessageForScan(e,f,d),n.setProgressForScan(e,f,d),n.setProgressForAll(),a.error("Oops, an error occurred","Please look at the console output for details"),console.error(t)}})})}else a.warning("No files found","The extension EXT:"+e+" contains no files we can scan")}else a.error("Oops, an error occurred","Please look at the console output for details"),console.error(o)},error:function(e){i.handleAjaxError(e,r)}})},e}())});